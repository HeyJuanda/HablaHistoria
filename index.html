<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="google-adsense-account" content="ca-pub-9925435155682261">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blog â€¢ HablaHistoria</title>
  <link rel="icon" href="logo.jpg" type="image/x-icon">
  <style>
    :root {
      --bg:#ffffff; 
      --card:#fffaf0; 
      --input:#ffffff; 
      --border:#ffbf69; 
      --text:#000000; 
      --primary:#ff9f1c;
    }
    body { margin:0; font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); }
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px; background:#ff9f1c; color:#fff;
      border-bottom:2px solid #e67e00; position:sticky; top:0; z-index:10
    }
    header h1 { 
      font-size:28px; margin:0; color:#fff; 
      display:flex; align-items:center; gap:5px;
    }
    header h1 img {
      width:38px;
      height:38px;
      border-radius:50%;
      object-fit:cover;
    }
    .btn {
      background:var(--primary); color:#ffffff; border:none;
      border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer
    }
    .btn.ghost {
      background:transparent; border:1px solid var(--border); color:#e67e00
    }
    .container { max-width:900px; max-height: 400px; margin:24px auto; padding:0 16px}
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px }
    .stack { display:grid; gap:12px }
    input, textarea, select {
      width: 95%; padding:12px; border-radius:12px; margin-bottom: 4px;
      border:1px solid var(--border); background:var(--input); color:#000; outline:none
    }
    textarea { min-height:110px; resize:vertical }
    .grid { display:grid; gap:12px }
    @media(min-width:720px) { .grid.cols-2 { grid-template-columns:1fr 1fr } }
    .post {
      background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:14px; transition:all 0.3s ease-in-out;
      position:relative;
    }
    .post h3 { margin:0 0 6px 0; color:#e67e00; cursor:pointer }
    .meta { opacity:.8; font-size:12px; margin-bottom:6px }
    .media img, .media video, .media audio {
      max-width:100%; border-radius:10px; margin-top:8px; display:block
    }
    .tag {
      display:inline-block; background:#ffefcc;
      border:1px solid #ffbf69; padding:4px 8px;
      border-radius:999px; font-size:12px; margin-right:6px; margin-bottom:1.4px
    }
    .muted { opacity:.7 }
    .empty {
      border:1px dashed var(--border); border-radius:12px;
      padding:18px; text-align:center
    }
    .content-collapsed {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .content-expanded {
      max-height: 1000px;
      transition: max-height 0.5s ease;
    }
    .toggle-content-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      padding: 6px 0;
      font-size: 14px;
      margin-top: 8px;
      text-align: left;
    }
    /* Estilos para previews */
    .link-preview {
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 10px;
      margin-top: 6px;
      background: #fffef8;
    }
    .link-preview img {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .link-preview a {
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      word-break: break-all;
    }
    /* Comentarios */
    .comments { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
    .comment { padding: 4px 0; font-size: 14px; }
    .comments-list { margin-bottom: 8px; }

    /* === Uploader Cloudinary === */
    .uploader { border:1px dashed var(--border); max-width: 95%; background:#fff; border-radius:12px; padding:12px }
    .uploader small { display:block; margin-top:6px }
    .uploads { display:grid; gap:8px; margin-top:8px }
    .upload-item { font-size:14px; background:#fffef8; border:1px solid var(--border); border-radius:8px; padding:8px }
    progress { width:100%; height:10px }
  </style>
</head>
<body>
<header>
  <h1> <img src="logo.jpg"> Habla Historia</h1>
  <div class="actions">
    <button onclick="location.href='https://www.youtube.com/@hablahistoria?sub_confirmation=1'" class="btn">Youtube</button>
    <button onclick="location.href='chat.html'" class="btn">Chats</button>
    <button class="btn" id="btnLogout">Cerrar sesiÃ³n</button>
  </div>
</header>

<div class="container stack">
  <!-- Panel Docente -->
  <div id="teacherPanel" class="card stack" style="display:none">
    <h2 style="margin:0;color:#e67e00">Publicar (docente)</h2>
    <div class="grid cols-2">
      <input id="postTitle" placeholder="TÃ­tulo" />
      <select id="postGrades" multiple>
        <option value="7A">7Â° "A"</option>
        <option value="7B">7Â° "B"</option>
        <option value="8A">8Â° "A"</option>
        <option value="8B">8Â° "B"</option>
        <option value="9A">9Â° "A"</option>
        <option value="9B">9Â° "B"</option>
      </select>
    </div>
    <textarea id="postContent" placeholder="Contenido..."></textarea>

    <!-- === Subida de archivos con Cloudinary === -->
    <div class="uploader">
      <strong>Subir archivos (imÃ¡genes / video / audio)</strong>
      <div class="grid cols-2" style="align-items:center">
        <input id="fileInput" type="file" multiple accept="image/*,video/*,audio/*" />
        <button class="btn" id="btnUpload">Subir</button>
      </div>
      <div id="uploads" class="uploads"></div>
    </div>

    <div class="stack">
      <label for="postFiles" class="muted">Enlaces â€” admite imÃ¡genes, video o audio. (Separalas por linea)</label>
      <textarea id="postFiles" placeholder="https://...jpg\nhttps://...mp4\nhttps://...mp3\nhttps://...link"></textarea>
    </div>
    <div>
      <button class="btn" id="btnPublish">Publicar</button>
    </div>
  </div>

  <!-- Lista de publicaciones -->
  <div id="postsWrap" class="stack">
    <div id="infoBox" class="empty muted">Cargando publicacionesâ€¦</div>
    <div id="postsList" class="stack"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyB0MfByHYHikrECUDVM2QenIsLiLmoS_FM",
    authDomain: "hablahistoria-802fd.firebaseapp.com",
    projectId: "hablahistoria-802fd",
    storageBucket: "hablahistoria-802fd.appspot.com",
    messagingSenderId: "322467465610",
    appId: "1:322467465610:web:98da756bc6d80f440a6073",
  };

  const TEACHER_EMAILS = ["hey.junda@gmail.com", "yesenia.lisseth.flores@clases.edu.sv",];
  const LINK_API_KEY = "a30ad1652095af5a53163f76aec86711"; // ðŸ‘‰ consigue tu API key gratis en linkpreview.net

  // === ConfiguraciÃ³n Cloudinary (REEMPLAZA ESTOS VALORES) ===
  // 1) Crea un Upload Preset SIN firmar (unsigned) en tu cuenta Cloudinary.
  // 2) Coloca aquÃ­ tu cloud name y el nombre del preset.
  const CLOUDINARY_CLOUD_NAME = "dzkddfq8b"; // p.ej. "demo"
  const CLOUDINARY_UPLOAD_PRESET = "unsigned_default"; // p.ej. "unsigned_default"
  // (Opcional) carpeta destino dentro de Cloudinary
  const CLOUDINARY_FOLDER = "hablahistoria";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const teacherPanel = document.getElementById('teacherPanel');
  const postsList = document.getElementById('postsList');
  const infoBox = document.getElementById('infoBox');

  // Uploader refs
  const fileInput = document.getElementById('fileInput');
  const btnUpload = document.getElementById('btnUpload');
  const uploadsWrap = document.getElementById('uploads');
  const postFilesTA = document.getElementById('postFiles');

  let currentUser = null;
  let userGrade = null;

  function parseUrls(raw) {
    return raw.split('\n').map(s => s.trim()).filter(Boolean);
  }

  // === Cloudinary: subida de archivos (unsigned) ===
  async function uploadToCloudinary(file) {
    const endpoint = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    if (CLOUDINARY_FOLDER) fd.append('folder', CLOUDINARY_FOLDER);

    // UI item
    const item = document.createElement('div');
    item.className = 'upload-item';
    item.innerHTML = `<strong>${file.name}</strong><br><progress value="0" max="100"></progress><span class="muted"> Subiendoâ€¦</span>`;
    const progressEl = item.querySelector('progress');
    const statusEl = item.querySelector('span');
    uploadsWrap.appendChild(item);

    try {
      // fetch no expone progreso nativo; usamos xhr para mostrar avance real
      const res = await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', endpoint);
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve(xhr) : reject(new Error(xhr.responseText));
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) progressEl.value = Math.round((e.loaded / e.total) * 100);
        };
        xhr.send(fd);
      });

      const data = JSON.parse(res.responseText);
      statusEl.textContent = ' Listo âœ…';
      progressEl.value = 100;

      // Agregar URL al textarea (nueva lÃ­nea)
      const url = data.secure_url;
      postFilesTA.value = (postFilesTA.value ? postFilesTA.value + '\n' : '') + url;

      // Vista previa rÃ¡pida si es imagen
      if (data.resource_type === 'image') {
        const img = document.createElement('img');
        img.src = data.secure_url;
        img.alt = file.name;
        img.style.maxWidth = '160px';
        img.style.borderRadius = '8px';
        img.style.display = 'block';
        img.style.marginTop = '6px';
        item.appendChild(img);
      }

      return data;
    } catch (err) {
      statusEl.textContent = ' Error âŒ';
      console.error('Cloudinary upload error:', err);
      alert('No se pudo subir: ' + file.name);
      throw err;
    }
  }

  btnUpload?.addEventListener('click', async () => {
    const files = Array.from(fileInput.files || []);
    if (!files.length) {
      alert('Selecciona al menos un archivo.');
      return;
    }

    if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET || CLOUDINARY_CLOUD_NAME.includes('tu_')) {
      alert('Configura CLOUDINARY_CLOUD_NAME y CLOUDINARY_UPLOAD_PRESET en el cÃ³digo.');
      return;
    }

    for (const f of files) {
      await uploadToCloudinary(f);
    }

    // Limpia el input tras subir
    fileInput.value = '';
  });

  // PrevisualizaciÃ³n de links con API externa
  async function renderMedia(url) {
    const u = url.toLowerCase();
    if (u.match(/\.(jpg|jpeg|png|gif|webp)$/)) {
      return `<img src="${url}" alt="Imagen relacionada" />`;
    }
    if (u.match(/\.(mp4|webm|ogg)$/)) {
      return `<video controls src="${url}"></video>`;
    }
    if (u.match(/\.(mp3|wav|ogg)$/)) {
      return `<audio controls src="${url}"></audio>`;
    }

    // Fetch a API LinkPreview
    try {
      const res = await fetch(`https://api.linkpreview.net/?key=${LINK_API_KEY}&q=${encodeURIComponent(url)}`);
      const data = await res.json();
      return `
        <div class="link-preview">
          ${data.image ? `<img src="${data.image}" alt="preview"/>` : ""}
          <a href="${data.url}" target="_blank">${data.title || url}</a>
          <p>${data.description || ""}</p>
        </div>`;
    } catch (e) {
      return `<div class="link-preview"><a href="${url}" target="_blank">${url}</a></div>`;
    }
  }

  function fmtDate(d) {
    try {
      const date = d?.toDate ? d.toDate() : new Date(d);
      return date.toLocaleString();
    } catch {
      return "";
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }
    currentUser = user;
    if (TEACHER_EMAILS.includes(user.email)) teacherPanel.style.display = 'block';
    userGrade = await getUserGrade(user.uid) || localStorage.getItem('gradoUsuario');
    await loadPosts();
  });

  async function getUserGrade(uid) {
    try {
      const snap = await getDoc(doc(db, "usuarios", uid));
      return snap.exists() ? snap.data().grado : null;
    } catch {
      return null;
    }
  }

  document.getElementById('btnPublish')?.addEventListener('click', async () => {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    const files = parseUrls(document.getElementById('postFiles').value);
    const gradesSel = Array.from(document.getElementById('postGrades').selectedOptions).map(o => o.value);
    if (!title || !content || !gradesSel.length) {
      alert("Completa todos los campos.");
      return;
    }
    try {
      await addDoc(collection(db, "posts"), {
        title,
        content,
        allowedGrades: gradesSel,
        files,
        authorUid: currentUser.uid,
        authorEmail: currentUser.email,
        createdAt: serverTimestamp()
      });
      document.getElementById('postTitle').value = "";
      document.getElementById('postContent').value = "";
      document.getElementById('postFiles').value = "";
      Array.from(document.getElementById('postGrades').options).forEach(o => o.selected = false);
      uploadsWrap.innerHTML = '';
      await loadPosts();
      alert("Publicado âœ…");
    } catch (err) {
      console.error(err);
      alert("No se pudo publicar.");
    }
  });

  async function loadPosts() {
    postsList.innerHTML = "";
    infoBox.style.display = 'block';
    infoBox.textContent = "Cargandoâ€¦";
    try {
      let snap;
      if (TEACHER_EMAILS.includes(currentUser.email)) {
        snap = await getDocs(query(collection(db, "posts"), orderBy("createdAt", "desc")));
      } else {
        if (!userGrade) {
          infoBox.textContent = "No encontramos tu grado.";
          return;
        }
        snap = await getDocs(query(collection(db, "posts"), where("allowedGrades", "array-contains", userGrade)));
      }

      const posts = [];
      snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
      posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      infoBox.style.display = posts.length ? 'none' : 'block';
      infoBox.textContent = posts.length ? "" : "No hay publicaciones.";

      for (const p of posts) {
        const el = document.createElement('div');
        el.className = "post";

        const toggle = document.createElement('h3');
        toggle.textContent = p.title;
        toggle.style.cursor = "pointer";

        const contentDiv = document.createElement('div');
        contentDiv.className = "content-collapsed";

        // renderMedia ahora es async â†’ procesamos cada archivo
        const mediaHtmls = await Promise.all((p.files || []).map(renderMedia));

        contentDiv.innerHTML = `
          <p>${(p.content || "").replace(/\n/g, "<br>")}</p>
          <div class="media">${mediaHtmls.join("")}</div>`;

        const toggleContentBtn = document.createElement('button');
        toggleContentBtn.className = "toggle-content-btn";
        toggleContentBtn.textContent = "Mostrar";
        toggleContentBtn.onclick = () => {
          const isCollapsed = contentDiv.classList.contains("content-collapsed");
          if (isCollapsed) {
            contentDiv.classList.remove("content-collapsed");
            contentDiv.classList.add("content-expanded");
            toggleContentBtn.textContent = "Ocultar";
          } else {
            contentDiv.classList.add("content-collapsed");
            contentDiv.classList.remove("content-expanded");
            toggleContentBtn.textContent = "Mostrar";
          }
        };

        const meta = document.createElement('div');
        meta.className = "meta muted";
        meta.innerHTML = `${p.authorEmail || ""} â€¢ ${fmtDate(p.createdAt)}<br>
          ${(p.allowedGrades || []).map(g => `<span class="tag">${g}</span>`).join(" ")}`;

        el.appendChild(toggle);
        el.appendChild(meta);
        el.appendChild(toggleContentBtn);
        el.appendChild(contentDiv);

        // Comentarios
        const commentsDiv = document.createElement("div");
        commentsDiv.className = "comments";
        const commentsList = document.createElement("div");
        commentsList.className = "comments-list";
        commentsDiv.appendChild(commentsList);

        const commentInput = document.createElement("input");
        commentInput.placeholder = "Escribe un comentario...";
        commentInput.style.width = "80%";

        const commentBtn = document.createElement("button");
        commentBtn.textContent = "Responder";
        commentBtn.className = "btn";
        commentBtn.style.marginLeft = "6px";

        commentBtn.onclick = async () => {
          const text = commentInput.value.trim();
          if (!text) return;
          try {
            await addDoc(collection(db, "posts", p.id, "comments"), {
              text,
              author: currentUser.email,
              createdAt: serverTimestamp()
            });
            commentInput.value = "";
            await loadComments(p.id, commentsList);
          } catch (err) {
            console.error(err);
            alert("No se pudo comentar.");
          }
        };

        commentsDiv.appendChild(commentInput);
        commentsDiv.appendChild(commentBtn);
        el.appendChild(commentsDiv);

        await loadComments(p.id, commentsList);

        // BotÃ³n eliminar solo para docentes
        if (TEACHER_EMAILS.includes(currentUser.email)) {
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ðŸ—‘ Eliminar";
          deleteBtn.className = "btn ghost";
          deleteBtn.style.marginTop = "10px";
          deleteBtn.onclick = async () => {
            const confirmDelete = confirm(`Â¿Eliminar publicaciÃ³n: "${p.title}"?`);
            if (!confirmDelete) return;
            try {
              await deleteDoc(doc(db, "posts", p.id));
              await loadPosts();
              alert("PublicaciÃ³n eliminada âœ…");
            } catch (err) {
              console.error(err);
              alert("Error al eliminar.");
            }
          };
          el.appendChild(deleteBtn);
        }

        postsList.appendChild(el);
      }
    } catch (err) {
      console.error(err);
      infoBox.textContent = "Error cargando publicaciones.";
    }
  }

  async function loadComments(postId, container) {
    container.innerHTML = "Cargando comentarios...";
    try {
      const snap = await getDocs(query(
        collection(db, "posts", postId, "comments"),
        orderBy("createdAt", "asc")
      ));
      if (snap.empty) {
        container.innerHTML = "<p class='muted'>Sin comentarios</p>";
        return;
      }
      container.innerHTML = "";
      snap.forEach(d => {
        const c = d.data();
        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `<strong>${c.author}</strong>: ${c.text}`;
        container.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p class='muted'>Error cargando comentarios</p>";
    }
  }

  document.getElementById('btnLogout').addEventListener('click', async () => {
    await signOut(auth);
    location.href = "login.html";
  });
</script>
</body>
</html>







