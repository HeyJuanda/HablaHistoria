<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Acceso â€¢ HablaHistoria</title>
<link rel="icon" href="logo.jpg" type="image/x-icon">
<style>
  body {
    margin:0;
    font-family: system-ui, sans-serif;
    background: #ffffff;
    color:#000;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    flex-direction: column;
  }
  .logo {
    text-align:center;
    margin-bottom:20px;
  }
  .logo img {
    width:300px;
    height:auto;
  }
  .card {
    background: #fffaf0;
    padding:32px;
    border-radius:16px;
    width:100%;
    max-width:400px;
    box-shadow:0 0 25px rgba(0,0,0,0.1);
    border:2px solid #ff9f1c;
  }
  h2{text-align:center;margin-bottom:16px;color:#ff9f1c;}
  input, select {
    width:93%;
    padding:12px;
    border-radius:12px;
    border:1px solid #ff9f1c;
    background:#fff;
    color:#000;
    margin-bottom:12px;
  }
  button {
    width:100%;
    padding:12px;
    border-radius:12px;
    border:none;
    background:#ff9f1c;
    color:#fff;
    cursor:pointer;
    font-weight:600;
    margin-bottom:12px;
    transition: background 0.2s;
  }
  button:hover{background:#e68900;}
  .link-btn{
    background:none;
    border:none;
    color:#e67e00;
    cursor:pointer;
    text-decoration:underline;
    padding:0;
    font-size:14px;
  }
  .alert{
    display:none;
    padding:10px;
    border-radius:12px;
    text-align:center;
    margin-bottom:12px;
    font-weight:600;
  }
  .alert.success{background:#d1fae5;color:#065f46;}
  .alert.error{background:#fee2e2;color:#991b1b;}
  .hidden{display:none;}
</style>
</head>
<body>

<div class="logo">
  <img src="hug.svg" alt="Hug-oh Logo">
</div>

<div class="card">
  <!-- LOGIN -->
  <div id="loginForm">
    <h2>Iniciar sesiÃ³n</h2>
    <div id="loginMsg" class="alert"></div>
    <input type="text" id="loginName" placeholder="Nombre completo" required>
    <input type="email" id="loginEmail" placeholder="Correo" required>
    <input type="password" id="loginPass" placeholder="ContraseÃ±a" required>
    <button id="btnLogin">Entrar</button>
    <button class="link-btn" onclick="toggleForms()">Â¿No tienes cuenta? Crear una</button>
  </div>

  <!-- REGISTER -->
  <div id="registerForm" class="hidden">
    <h2>Crear cuenta</h2>
    <div id="regMsg" class="alert"></div>
    <input type="text" id="regName" placeholder="Nombre completo" required>
    <input type="text" id="regNIE" placeholder="NÃºmero de NIE" required>
    <select id="regGrade" required>
      <option value="">Selecciona tu grado</option>
      <option value="7A">7A</option>
      <option value="7B">7B</option>
      <option value="8A">8A</option>
      <option value="8B">8B</option>
      <option value="9A">9A</option>
      <option value="9B">9B</option>
    </select>
    <input type="email" id="regEmail" placeholder="Correo" required>
    <input type="password" id="regPass" placeholder="ContraseÃ±a" required>
    <button id="btnRegister">Crear cuenta</button>
    <button class="link-btn" onclick="toggleForms()">Â¿Ya tienes cuenta? Inicia sesiÃ³n</button>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  updateProfile, 
  setPersistence, 
  browserLocalPersistence,
  onAuthStateChanged 
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyB0MfByHYHikrECUDVM2QenIsLiLmoS_FM",
  authDomain: "hablahistoria-802fd.firebaseapp.com",
  projectId: "hablahistoria-802fd",
  storageBucket: "hablahistoria-802fd.firebasestorage.app",
  messagingSenderId: "322467465610",
  appId: "1:322467465610:web:98da756bc6d80f440a6073",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Inicializar persistencia correctamente
async function initAuth() {
  try {
    await setPersistence(auth, browserLocalPersistence);
  } catch (e) {
    console.error("Error en persistencia", e);
  }
}
initAuth();

// ðŸ”¥ Detectar si ya hay sesiÃ³n activa
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const docRef = doc(db, "usuarios", user.uid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const datos = docSnap.data();
      localStorage.setItem("nombreUsuario", datos.nombre);
      localStorage.setItem("gradoUsuario", datos.grado);
      window.location.href = "index.html";
    }
  }
});

// Cambiar entre login y registro
window.toggleForms = function(){
  document.getElementById("loginForm").classList.toggle("hidden");
  document.getElementById("registerForm").classList.toggle("hidden");
}

// LOGIN
const loginMsg = document.getElementById('loginMsg');
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  loginMsg.style.display='none';
  const name = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;

  if(!name || !email || !pass){
    loginMsg.textContent='Por favor, completa todos los campos.';
    loginMsg.className='alert error';
    loginMsg.style.display='block';
    return;
  }

  try{
    const {user} = await signInWithEmailAndPassword(auth,email,pass);
    const docRef = doc(db, "usuarios", user.uid);
    const docSnap = await getDoc(docRef);

    if(docSnap.exists()){
      const datos = docSnap.data();
      if(datos.nombre.toLowerCase() !== name.toLowerCase()){
        loginMsg.textContent='El nombre no coincide con el de la cuenta.';
        loginMsg.className='alert error';
        loginMsg.style.display='block';
        return;
      }
      localStorage.setItem("nombreUsuario", datos.nombre);
      localStorage.setItem("gradoUsuario", datos.grado);
      window.location.href = "index.html";
    } else {
      loginMsg.textContent='No se encontraron datos de este usuario.';
      loginMsg.className='alert error';
      loginMsg.style.display='block';
    }
  }catch(err){
    loginMsg.textContent = err.message;
    loginMsg.className='alert error';
    loginMsg.style.display='block';
  }
});

// REGISTER
const regMsg = document.getElementById('regMsg');
document.getElementById('btnRegister').addEventListener('click', async ()=>{
  regMsg.style.display='none';
  const name = document.getElementById('regName').value.trim();
  const nie = document.getElementById('regNIE').value.trim();
  const grade = document.getElementById('regGrade').value;
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;

  if(!name || !nie || !grade || !email || !pass){
    regMsg.textContent='Por favor, completa todos los campos.';
    regMsg.className='alert error';
    regMsg.style.display='block';
    return;
  }

  try{
    const {user} = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(user,{displayName:name});
    await setDoc(doc(db, "usuarios", user.uid), {
      nombre: name,
      nie: nie,
      grado: grade,
      email: email,
      creado: new Date()
    });
    localStorage.setItem("nombreUsuario", name);
    localStorage.setItem("gradoUsuario", grade);
    window.location.href = "index.html";
  }catch(err){
    regMsg.textContent = err.message;
    regMsg.className='alert error';
    regMsg.style.display='block';
  }
});
</script>
</body>
</html>
