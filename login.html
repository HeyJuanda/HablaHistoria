<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iniciar sesión • Hug-Oh</title>
<style>
  body { margin:0; font-family:system-ui,sans-serif; background:#0b0f19; color:#e8ecff; display:flex; justify-content:center; align-items:center; min-height:100vh;}
  .card { background:#12182a; padding:32px; border-radius:16px; width:100%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.5);}
  h2{text-align:center;margin-bottom:16px;}
  input{width:93%;padding:12px;border-radius:12px;border:1px solid #2f3a5a;background:#0a0e1c;color:#fff;margin-bottom:12px;}
  button{width:100%;padding:12px;border-radius:12px;border:none;background:#6aa4ff;color:#fff;cursor:pointer;font-weight:600;margin-bottom:12px;}
  .link-btn{background:none;border:none;color:#6aa4ff;cursor:pointer;text-decoration:underline;padding:0;font-size:14px;}
  .alert{display:none;padding:10px;border-radius:12px;text-align:center;margin-bottom:12px;}
  .alert.success{background:rgba(34,197,94,0.2);color:#16a34a;}
  .alert.error{background:rgba(239,68,68,0.2);color:#b91c1c;}
</style>
</head>
<body>

<div class="card">
  <h2>Iniciar sesión</h2>
  <div id="loginMsg" class="alert"></div>
  <input type="text" id="loginName" placeholder="Nombre completo" required>
  <input type="email" id="loginEmail" placeholder="Correo" required>
  <input type="password" id="loginPass" placeholder="Contraseña" required>
  <button id="btnLogin">Entrar</button>
  <button class="link-btn" onclick="location.href='register.html'">Crear cuenta</button>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBTARrZlvWOsld1kzdiHzE3_U9hdieHfvU",
  authDomain: "hug-oh.firebaseapp.com",
  projectId: "hug-oh",
  appId: "1:849653738783:web:16fb8b60d04645cb90542a",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await setPersistence(auth, browserLocalPersistence);

const loginMsg = document.getElementById('loginMsg');

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  loginMsg.style.display='none';
  const name = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;

  if(!name || !email || !pass){
    loginMsg.textContent='Por favor, completa todos los campos.';
    loginMsg.className='alert error';
    loginMsg.style.display='block';
    return;
  }

  try{
    const {user} = await signInWithEmailAndPassword(auth,email,pass);

    // Verificar que el nombre coincida con el que tiene guardado en Firestore
    const docRef = doc(db, "usuarios", user.uid);
    const docSnap = await getDoc(docRef);

    if(docSnap.exists()){
      const datos = docSnap.data();
      if(datos.nombre.toLowerCase() !== name.toLowerCase()){
        loginMsg.textContent='El nombre no coincide con el de la cuenta.';
        loginMsg.className='alert error';
        loginMsg.style.display='block';
        return;
      }

      // Guardar datos en localStorage para bienvenida
      localStorage.setItem("nombreUsuario", datos.nombre);
      localStorage.setItem("gradoUsuario", datos.grado);

      // Redirigir a bienvenida
      window.location.href = "bienvenida.html";
    } else {
      loginMsg.textContent='No se encontraron datos de este usuario.';
      loginMsg.className='alert error';
      loginMsg.style.display='block';
    }

  }catch(err){
    const msg = {
      'auth/invalid-credential':'Correo o contraseña incorrectos.',
      'auth/user-not-found':'Usuario no encontrado.',
      'auth/wrong-password':'Contraseña incorrecta.'
    }[err.code]||'Ocurrió un error.';
    loginMsg.textContent=msg;
    loginMsg.className='alert error';
    loginMsg.style.display='block';
  }
});
</script>
</body>
</html>
