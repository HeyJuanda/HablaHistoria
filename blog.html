<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Blog ‚Ä¢ Hug-Oh</title>
<style>
  :root{
    --bg:#0b0f19; --card:#12182a; --input:#0a0e1c; --border:#2f3a5a; --text:#e8ecff; --primary:#6aa4ff;
  }
  body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#0e1426;border-bottom:1px solid #0f1a35;position:sticky;top:0;z-index:10}
  header h1{font-size:18px;margin:0;color:var(--primary)}
  header .actions{display:flex;gap:8px}
  a,button{cursor:pointer}
  .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid var(--border)}
  .container{max-width:900px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .stack{display:grid;gap:12px}
  input, textarea, select{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
    background:var(--input);color:#fff;outline:none
  }
  textarea{min-height:110px;resize:vertical}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
  .post{background:#0e1426;border:1px solid var(--border);border-radius:12px;padding:14px}
  .post h3{margin:0 0 6px 0}
  .meta{opacity:.8;font-size:12px;margin-bottom:8px}
  .media img, .media video, .media audio{max-width:100%;border-radius:10px;margin-top:8px;display:block}
  .tag{display:inline-block;background:#1a2340;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px;margin-bottom:6px}
  .comment{background:#101733;border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:8px}
  .muted{opacity:.7}
  .empty{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center}
</style>
</head>
<body>
<header>
  <h1>üìù Blog Escolar</h1>
  <div class="actions">
    <button class="btn ghost" onclick="location.href='index.html'">Inicio</button>
    <button class="btn ghost" onclick="location.href='status.html'">Estad√≠sticas</button>
    <button class="btn" id="btnLogout">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="container stack">
  <!-- Panel DOCENTE -->
  <div id="teacherPanel" class="card stack" style="display:none">
    <h2 style="margin:0">Publicar (docente)</h2>
    <div class="grid cols-2">
      <input id="postTitle" placeholder="T√≠tulo" />
      <select id="postGrades" multiple>
        <option value="7A">7¬∞ "A"</option>
        <option value="7B">7¬∞ "B"</option>
        <option value="8A">8¬∞ "A"</option>
        <option value="8B">8¬∞ "B"</option>
        <option value="9A">9¬∞ "A"</option>
        <option value="9B">9¬∞ "B"</option>
      </select>
    </div>
    <textarea id="postContent" placeholder="Contenido..."></textarea>
    <div class="stack">
      <label for="postFiles" class="muted">Enlaces (una URL por l√≠nea) ‚Äî admite im√°genes, video o audio</label>
      <textarea id="postFiles" placeholder="https://...jpg
https://...mp4
https://...mp3"></textarea>
    </div>
    <div>
      <button class="btn" id="btnPublish">Publicar</button>
    </div>
  </div>

  <!-- Lista de publicaciones -->
  <div id="postsWrap" class="stack">
    <div id="infoBox" class="empty muted">Cargando publicaciones‚Ä¶</div>
    <div id="postsList" class="stack"></div>
  </div>
</div>

<script type="module">
  // Firebase v10 (m√≥dulos) ‚Äî MISMO SDK que ya usas en tus otras p√°ginas
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { 
    getFirestore, doc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp 
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Usa tu misma config (la que ya tienes funcionando)
  const firebaseConfig = {
    apiKey: "AIzaSyBTARrZlvWOsld1kzdiHzE3_U9hdieHfvU",
    authDomain: "hug-oh.firebaseapp.com",
    projectId: "hug-oh",
    appId: "1:849653738783:web:16fb8b60d04645cb90542a",
  };

  const TEACHER_EMAIL = "hey.junda@gmail.com";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const teacherPanel = document.getElementById('teacherPanel');
  const postsList = document.getElementById('postsList');
  const infoBox = document.getElementById('infoBox');

  let currentUser = null;
  let userGrade = null; // "7A" | "7B" | ...

  // Helpers ---------------

  function parseUrls(raw) {
    return raw.split('\n')
      .map(s => s.trim())
      .filter(Boolean);
  }

  function renderMedia(url){
    const u = url.toLowerCase();
    if (u.match(/\.(jpg|jpeg|png|gif|webp)$/)) {
      return `<img src="${url}" alt="">`;
    } else if (u.match(/\.(mp4|webm|ogg)$/)) {
      return `<video controls src="${url}"></video>`;
    } else if (u.match(/\.(mp3|wav|ogg)$/)) {
      return `<audio controls src="${url}"></audio>`;
    } else {
      return `<a href="${url}" target="_blank" rel="noopener">Abrir enlace</a>`;
    }
  }

  function fmtDate(d){
    try{
      const date = d?.toDate ? d.toDate() : (d instanceof Date ? d : new Date(d));
      return date.toLocaleString();
    }catch{ return ""; }
  }

  // Auth + perfil ----------
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }
    currentUser = user;

    // Mostrar panel docente si corresponde
    if (user.email === TEACHER_EMAIL) {
      teacherPanel.style.display = 'block';
    }

    // Obtener grado del alumno desde Firestore (colecci√≥n "usuarios")
    userGrade = await getUserGrade(user.uid);

    // Si no est√° en Firestore, intenta con localStorage (por si a√∫n no se sincroniz√≥)
    if (!userGrade) {
      userGrade = localStorage.getItem('gradoUsuario') || null;
    }

    // Cargar publicaciones
    await loadPosts();
  });

  async function getUserGrade(uid){
    try{
      const snap = await getDoc(doc(db, "usuarios", uid));
      if (snap.exists()) {
        const data = snap.data();
        return data.grado || null; // valores como "7A", "8B", etc.
      }
      return null;
    }catch(e){
      console.error("Error leyendo perfil:", e);
      return null;
    }
  }

  // Publicar (docente) -----
  document.getElementById('btnPublish')?.addEventListener('click', async () => {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    const filesRaw = document.getElementById('postFiles').value;
    const gradesSel = Array.from(document.getElementById('postGrades').selectedOptions).map(o => o.value);

    if (!title || !content) {
      alert("Escribe t√≠tulo y contenido.");
      return;
    }
    if (!gradesSel.length) {
      alert("Selecciona al menos un grado.");
      return;
    }

    const files = parseUrls(filesRaw);

    try{
      await addDoc(collection(db, "posts"), {
        title,
        content,
        allowedGrades: gradesSel, // ["7A","8B",...]
        files,                    // array de URLs
        authorUid: currentUser.uid,
        authorEmail: currentUser.email,
        createdAt: serverTimestamp()
      });

      // reset UI
      document.getElementById('postTitle').value = "";
      document.getElementById('postContent').value = "";
      document.getElementById('postFiles').value = "";
      Array.from(document.getElementById('postGrades').options).forEach(o=>o.selected=false);

      await loadPosts();
      alert("Publicado ‚úÖ");
    }catch(err){
      console.error(err);
      alert("No se pudo publicar. Revisa permisos de Firestore.");
    }
  });

  // Cargar posts ----------
  async function loadPosts(){
    postsList.innerHTML = "";
    infoBox.style.display = 'block';
    infoBox.textContent = "Cargando publicaciones‚Ä¶";

    try{
      let snap;
      if (currentUser.email === TEACHER_EMAIL) {
        // Docente ve todo (ordenado por fecha)
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        snap = await getDocs(q);
      } else {
        // Estudiante ve solo su grado (filtrado por array-contains)
        if (!userGrade) {
          infoBox.innerHTML = 'No encontramos tu grado en tu perfil. Pide al docente que actualice tu informaci√≥n.';
          return;
        }
        const q = query(
          collection(db, "posts"),
          where("allowedGrades", "array-contains", userGrade)
        );
        snap = await getDocs(q);
      }

      const posts = [];
      snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
      // Si ven√≠a sin orderBy (cuando usamos where), ordenamos aqu√≠:
      posts.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

      infoBox.style.display = posts.length ? 'none' : 'block';
      infoBox.innerHTML = posts.length ? "" : 'No hay publicaciones todav√≠a.';

      for (const p of posts) {
        const el = document.createElement('div');
        el.className = "post";
        el.innerHTML = `
          <h3>${p.title}</h3>
          <div class="meta muted">
            ${p.authorEmail || ""} ‚Ä¢ ${fmtDate(p.createdAt)}<br>
            ${Array.isArray(p.allowedGrades) ? p.allowedGrades.map(g=>`<span class="tag">${g}</span>`).join(" ") : ""}
          </div>
          <p>${p.content.replace(/\n/g,'<br>')}</p>
          <div class="media">
            ${(p.files||[]).map(renderMedia).join("")}
          </div>
          <div class="stack" style="margin-top:10px">
            <div id="comments-${p.id}" class="stack"></div>
            <div class="grid cols-2">
              <input id="cmt-${p.id}" placeholder="Escribe un comentario...">
              <button class="btn" data-post="${p.id}">Responder</button>
            </div>
          </div>
        `;
        postsList.appendChild(el);

        // cargar comentarios de este post
        await loadComments(p.id);
      }

      // listeners para comentar
      postsList.querySelectorAll('button[data-post]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const postId = e.currentTarget.getAttribute('data-post');
          const input = document.getElementById(`cmt-${postId}`);
          const text = (input.value||"").trim();
          if(!text) return;
          try{
            await addDoc(collection(db, "posts", postId, "comments"), {
              text,
              authorUid: currentUser.uid,
              authorName: currentUser.displayName || currentUser.email,
              createdAt: serverTimestamp()
            });
            input.value = "";
            await loadComments(postId);
          }catch(err){
            console.error(err);
            alert("No se pudo enviar el comentario.");
          }
        });
      });

    }catch(err){
      console.error(err);
      infoBox.style.display = 'block';
      infoBox.textContent = "Error cargando publicaciones.";
    }
  }

  async function loadComments(postId){
    const cont = document.getElementById(`comments-${postId}`);
    cont.innerHTML = "";
    try{
      const snap = await getDocs(query(collection(db, "posts", postId, "comments")));
      const comments = [];
      snap.forEach(d => comments.push(d.data()));
      comments.sort((a,b)=> (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
      if (!comments.length){
        cont.innerHTML = `<div class="muted" style="font-size:12px">A√∫n no hay comentarios.</div>`;
        return;
      }
      for (const c of comments){
        const div = document.createElement('div');
        div.className = "comment";
        div.innerHTML = `<strong>${c.authorName||'An√≥nimo'}</strong><br><span class="muted">${fmtDate(c.createdAt)}</span><br>${(c.text||'').replace(/\n/g,'<br>')}`;
        cont.appendChild(div);
      }
    }catch(err){
      console.error(err);
      cont.innerHTML = `<div class="muted">No se pudieron cargar los comentarios.</div>`;
    }
  }

  // logout
  document.getElementById('btnLogout').addEventListener('click', async ()=>{
    await signOut(auth);
    location.href = "login.html";
  });
</script>
</body>
</html>
