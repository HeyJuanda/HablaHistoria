<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Privado • HablaHistoria</title>
  <link rel="icon" href="logo.jpg" type="image/x-icon">
  <style>
    :root{
  --primary:#ff9f1c; --accent:#e67e00; --bg:#fff; --card:#fffaf0; --border:#ffbf69;
  --muted:#666;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:#111;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden
}
header{
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--primary);
  color:#fff
}
header h1{
  margin:0;
  font-size:20px;
  display:flex;
  gap:8px;
  align-items:center
}
#logo{height:40px;width:auto;border-radius:100%}
main.container{flex:1 1 auto;display:flex;flex-direction:column;overflow:hidden}
.layout{
  flex:1;
  display:grid;
  grid-template-columns:340px 1fr;
  gap:12px;
  padding:12px;
  overflow:hidden
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  overflow:hidden
}
.sidebar-card{
  display:flex;
  flex-direction:column;
  overflow:hidden;
  margin-bottom: 4px;
}
.section {
  display: flex;
  flex-direction: column;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  flex: 1;
  margin-bottom: 4px; /* espacio de 4px */
}
.section nav{
  background:var(--primary);
  color:#fff;
  padding:6px 10px;
  font-weight:bold;
  font-size:14px;
  flex:0 0 auto
}
.section-body{flex:1;display:flex;flex-direction:column;overflow:auto}
.section-chats{flex:1;overflow:auto}
.section-contacts{flex:1;overflow: auto;}
.chats-list{flex:1;overflow:auto}
.chat-item{
  padding:10px;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:8px
}
.chat-item.active{
  background:#fff2d9;
  border:1px solid var(--accent)
}
.messages{
  flex:1;
  overflow:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px
}
.msg{
  max-width:75%;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fffef8
}
.msg.me{margin-left:auto;background:#fff}
.meta{font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="text"], textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
  outline:none
}
.small{font-size:13px;color:var(--muted)}
.btn{
  background:var(--primary);
  border:none;
  color:#fff;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
}
.btn.ghost {
  background:transparent;
  border:none;        /* 🚫 sin borde */
  color:#fff;         /* ✅ texto blanco */
}
.muted{color:var(--muted)}
.files-list img,.files-list video,.files-list audio{
  max-width:200px;
  border-radius:8px;
  display:block;
  margin-top:6px
}
/* --- Diseño responsive --- */
/* --- Vista móvil estilo WhatsApp --- */
@media(max-width:860px){
  .layout{
    grid-template-columns: 1fr;  /* solo una columna */
  }
  .sidebar-card{
    display:block;
  }
  .card.chat-panel{
    display:none; /* oculto por defecto */
  }
  .card.chat-panel.active{
    display:flex; /* cuando se activa un chat */
    flex-direction:column;
  }
}


/* 🔹 Ajustes para inputs y botones más pequeños en la barra lateral */
/* 🔹 Inputs más pequeños, centrados dentro de la barra lateral */
.sidebar-card input[type="text"] {
  font-size: 13px;
  padding: 4px 6px;
  height: 26px;              /* más compacto */
  border-radius: 6px;
  border: 1px solid var(--border);
  margin: 0 auto;            /* centrado horizontal */
  display: block;
  width: calc(100% - 12px);  /* deja un pequeño margen con los bordes */
  box-sizing: border-box;
  margin-top: 4px;
  margin-bottom: 4px;
  margin-left: 4px; 
  margin-right: 4px
}
.sidebar-card .btn {
  font-size: 13px;
  padding: 4px 6px;
  border-radius: 6px;
}

.sidebar-card input[type="text"] {
  height: 28px;
}

.sidebar-card .btn {
  height: 28px;
  line-height: 1;
}

  </style>
</head>
<body>
<header>
  <h1><img id="logo" src="logo.jpg" alt="Logo"> Chat Privado</h1>
  <div style="display:flex;gap:8px">
    <button onclick="location.href='https://www.youtube.com/@hablahistoria?sub_confirmation=1'" class="btn">Youtube</button>
    <button id="btnIndex" class="btn ghost">Inicio</button>
    <button id="btnLogout" class="btn ghost">Cerrar sesión</button>
  </div>
</header>

<main class="container">
  <div class="layout">
    <!-- Sidebar -->
    <div class="card sidebar-card">

      <!-- Mis chats -->
      <div class="section section-chats">
        <nav>Mis chats</nav>
        <div class="section-body">
          <div style="margin:8px 0; display:flex; gap:6px;">
            <input id="newChatEmail" type="text" placeholder="Correos separados por coma" />
            <button id="btnNewChat" class="btn">Crear</button>
          </div>
          <div id="chatError" class="small muted"></div>
          <div class="chats-list" id="chatsList"><p class="muted">Cargando chats…</p></div>
        </div>
      </div>

      <!-- Contactos -->
      <div class="section section-contacts">
        <nav>Contactos de mi grado</nav>
        <div class="section-body">
          <div style="margin:8px 0; display:flex; gap:6px;">
            <input id="searchContacts" type="text" placeholder="Buscar contacto..." />
          </div>
          <div id="contactsList" class="chats-list"><p class="muted">Cargando contactos…</p></div>
        </div>
      </div>
    </div>

    <!-- Main -->
<div class="card chat-panel" style="overflow:hidden">
  <div style="flex:0 0 auto;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div>
      <strong id="chatTitle">Selecciona un chat</strong>
      <div id="chatParticipants" class="small muted"></div>
    </div>
    <button id="btnLeave" class="btn">Salir</button>
  </div>
  
  <div id="messagesWrap" class="messages" aria-live="polite">
    <p class="muted">No hay chat abierto.</p>
  </div>
  
  <div style="flex:0 0 auto;display:flex;flex-direction:column;gap:8px;overflow:auto">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="fileInputChat" type="file" />
      <button id="btnUploadFile" class="btn">Subir</button>
    </div>
    <textarea id="messageInput" placeholder="Escribe un mensaje..." rows="2"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="btnSend" class="btn">Enviar</button>
    </div>
  </div>
</div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp,
  doc, onSnapshot, orderBy, updateDoc
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyB0MfByHYHikrECUDVM2QenIsLiLmoS_FM",
  authDomain: "hablahistoria-802fd.firebaseapp.com",
  projectId: "hablahistoria-802fd",
  storageBucket: "hablahistoria-802fd.appspot.com",
  messagingSenderId: "322467465610",
  appId: "1:322467465610:web:98da756bc6d80f440a6073",
};

const CLOUDINARY_CLOUD_NAME = "dzkddfq8b";
const CLOUDINARY_UPLOAD_PRESET = "unsigned_default";
const CLOUDINARY_FOLDER = "hablahistoria";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const chatsListEl = document.getElementById('chatsList');
const contactsListEl = document.getElementById('contactsList');
const messagesWrap = document.getElementById('messagesWrap');
const chatTitle = document.getElementById('chatTitle');
const chatParticipants = document.getElementById('chatParticipants');
const btnNewChat = document.getElementById('btnNewChat');
const inputNewChat = document.getElementById('newChatEmail');
const chatError = document.getElementById('chatError');
const btnSend = document.getElementById('btnSend');
const messageInput = document.getElementById('messageInput');
const btnLeave = document.getElementById('btnLeave');
const btnIndex = document.getElementById('btnIndex');
const btnLogout = document.getElementById('btnLogout');
const fileInputChat = document.getElementById('fileInputChat');
const btnUploadFile = document.getElementById('btnUploadFile');
const searchContactsInput = document.getElementById('searchContacts');

let currentUser = null;
let currentChatId = null;
let unsubMessages = null;
let pendingFiles = [];
let currentUserName = null;
let nameCache = {}; // email -> nombre

function fmtDate(ts){
  try{ const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }catch{ return ''; }
}

async function fetchUserNameByEmail(email){
  if (nameCache[email]) return nameCache[email];
  const qUsers = query(collection(db, "usuarios"), where("email","==", email));
  const snap = await getDocs(qUsers);
  const name = snap.empty ? null : (snap.docs[0].data().nombre || null);
  if (name) nameCache[email] = name;
  return name;
}

async function preloadNames(emails){
  const uniq = [...new Set((emails||[]).filter(Boolean))];
  for (let i=0;i<uniq.length;i+=10){
    const chunk = uniq.slice(i,i+10);
    const qUsers = query(collection(db,"usuarios"), where("email","in", chunk));
    const snap = await getDocs(qUsers);
    snap.forEach(d=>{
      const data = d.data();
      if (data?.email && data?.nombre) nameCache[data.email] = data.nombre;
    });
  }
}

async function ensureCurrentUserName(){
  if (currentUserName) return currentUserName;
  const qUser = query(collection(db, "usuarios"), where("email","==", currentUser.email));
  const snapUser = await getDocs(qUser);
  if (!snapUser.empty) currentUserName = snapUser.docs[0].data().nombre || null;
  if (!currentUserName) currentUserName = currentUser.displayName || currentUser.email;
  return currentUserName;
}

async function loadMyChats(){
  chatsListEl.innerHTML = '<p class="muted">Cargando chats…</p>';
  const qChats = query(collection(db, 'privateChats'), where('participants', 'array-contains', currentUser.email));
  const snap = await getDocs(qChats);

  if (snap.empty){ chatsListEl.innerHTML = '<p class="muted">Aún no tienes chats.</p>'; return; }

  // Pre-cargar nombres
  const allOthers = [];
  snap.forEach(docSnap=>{
    const parts = (docSnap.data().participants || []).filter(e=>e!==currentUser.email);
    allOthers.push(...parts);
  });
  await preloadNames(allOthers);

  chatsListEl.innerHTML = '';
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const id = docSnap.id;
    const others = (data.participants||[]).filter(e=>e!==currentUser.email);
    const display = others.map(e=> nameCache[e] || e).join(', ') || 'Chat';

    const div = document.createElement('div');
    div.className = 'chat-item';
    div.dataset.chatId = id;
    div.innerHTML = `<strong>${display}</strong>
                     <div class="small muted">${fmtDate(data.lastAt)}</div>`;
    div.onclick = ()=> openChat(id, data);
    chatsListEl.appendChild(div);
  });
}

async function loadContactsByGrade(){
  contactsListEl.innerHTML = '<p class="muted">Cargando contactos…</p>';
  const qUser = query(collection(db, "usuarios"), where("email", "==", currentUser.email));
  const snapUser = await getDocs(qUser);
  if (snapUser.empty){ contactsListEl.innerHTML = '<p class="muted">No se encontró tu perfil.</p>'; return; }
  const userData = snapUser.docs[0].data();
  currentUserName = userData.nombre || currentUser.displayName || currentUser.email;
  const grado = userData.grado;

  const qContacts = query(collection(db, "usuarios"), where("grado", "==", grado));
  const snap = await getDocs(qContacts);
  if (snap.empty){ contactsListEl.innerHTML = '<p class="muted">No hay contactos en tu grado.</p>'; return; }

  contactsListEl.innerHTML = '';
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    if (data.email === currentUser.email) return;
    nameCache[data.email] = data.nombre;
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `<strong>${data.nombre}</strong><div class="small muted">${data.email}</div>`;
    div.onclick = ()=> createOrOpenChatWith(data.email);
    contactsListEl.appendChild(div);
  });
}

// --- Buscador de contactos ---
searchContactsInput?.addEventListener('input', ()=>{
  const term = searchContactsInput.value.toLowerCase();
  const items = contactsListEl.querySelectorAll('.chat-item');
  items.forEach(item=>{
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(term) ? '' : 'none';
  });
});

async function createOrOpenChatWith(input) {
  chatError.textContent = "";
  let emails = Array.isArray(input) ? input : input.split(",").map(e=>e.trim()).filter(e=>e.includes("@"));
  if (emails.length === 0) { chatError.textContent = "Introduce correos válidos."; return; }
  if (!emails.includes(currentUser.email)) emails.push(currentUser.email);

  const qChats = query(collection(db, 'privateChats'), where('participants', 'array-contains', currentUser.email));
  const snap = await getDocs(qChats);
  let existingChat = null;
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const parts = (data.participants || []).sort();
    if (JSON.stringify(parts) === JSON.stringify(emails.sort())) {
      existingChat = { id: docSnap.id, data };
    }
  });

  if (existingChat) {
    openChat(existingChat.id, existingChat.data);
  } else {
    const newDoc = await addDoc(collection(db, 'privateChats'), {
      participants: emails,
      createdAt: serverTimestamp(),
      lastAt: serverTimestamp()
    });
    openChat(newDoc.id, { participants: emails });
  }
  await loadMyChats();
  inputNewChat.value = "";
}

async function openChat(chatId, chatData){
  if (unsubMessages) unsubMessages();
  currentChatId = chatId;

  // 🔹 En móviles: ocultar lista y mostrar chat
  if (window.innerWidth <= 860) {
    document.querySelector(".sidebar-card").style.display = "none";
    document.querySelector(".chat-panel").classList.add("active");
  }

  // 🔹 Cargar nombres
  await preloadNames(chatData.participants || []);

  // 🔹 Título del chat (mostrar nombres de otros)
  chatTitle.textContent = (chatData.participants||[])
    .filter(e=>e!==currentUser.email)
    .map(e=> nameCache[e] || e)
    .join(', ') || "Chat";

  // 🔹 Participantes
  chatParticipants.textContent = "Participantes: " + (chatData.participants||[])
    .map(e=> nameCache[e] || e)
    .join(', ');

  // 🔹 Cargar mensajes
  messagesWrap.innerHTML = '<p class="muted">Cargando mensajes…</p>';
  const msgsRef = collection(db, 'privateChats', chatId, 'messages');
  const qMsgs = query(msgsRef, orderBy('createdAt', 'asc'));
  unsubMessages = onSnapshot(qMsgs, async snap=>{
    messagesWrap.innerHTML = '';
    if (snap.empty){ 
      messagesWrap.innerHTML = '<p class="muted">Aún no hay mensajes.</p>'; 
      return; 
    }
    for (const d of snap.docs){
      const m = d.data();
      const displayName = m.authorName || nameCache[m.authorEmail] || await fetchUserNameByEmail(m.authorEmail) || m.authorEmail;

      const wrapper = document.createElement('div');
      wrapper.className = 'msg ' + (m.authorEmail === currentUser.email ? 'me' : '');
      wrapper.innerHTML = `<div class="meta"><strong>${displayName}</strong> • ${fmtDate(m.createdAt)}</div>`;
      if (m.text) wrapper.innerHTML += `<div>${m.text}</div>`;
      if (m.files && m.files.length){
        const filesWrap = document.createElement('div');
        filesWrap.className = 'files-list';
        m.files.forEach(url=>{
          if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) filesWrap.innerHTML += `<img src="${url}">`;
          else if (url.match(/\.(mp4|webm|ogg)$/i)) filesWrap.innerHTML += `<video controls src="${url}"></video>`;
          else if (url.match(/\.(mp3|wav|ogg)$/i)) filesWrap.innerHTML += `<audio controls src="${url}"></audio>`;
          else filesWrap.innerHTML += `<a href="${url}" target="_blank">${url}</a>`;
        });
        wrapper.appendChild(filesWrap);
      }
      messagesWrap.appendChild(wrapper);
    }
    messagesWrap.scrollTop = messagesWrap.scrollHeight;
  });
}

btnSend.onclick = async ()=>{
  if (!currentChatId) return;
  const text = messageInput.value.trim();
  if (!text && pendingFiles.length===0) return;
  const name = await ensureCurrentUserName();
  const msgsRef = collection(db, 'privateChats', currentChatId, 'messages');
  await addDoc(msgsRef, {
    text: text || '',
    files: pendingFiles,
    authorEmail: currentUser.email,
    authorName: name,
    createdAt: serverTimestamp()
  });
  await updateDoc(doc(db, 'privateChats', currentChatId), { lastAt: serverTimestamp() });
  messageInput.value = '';
  pendingFiles = [];
};

btnUploadFile.onclick = async ()=>{
  const f = fileInputChat.files?.[0];
  if (!f){ chatError.textContent = "Selecciona un archivo"; return; }
  btnUploadFile.disabled = true;
  btnUploadFile.textContent = "Subiendo…";
  const data = await uploadToCloudinary(f);  // ❌ ESTA FUNCIÓN NO EXISTE
  pendingFiles.push(data.secure_url);
  chatError.textContent = "Archivo listo para enviar.";
  btnUploadFile.disabled = false;
  btnUploadFile.textContent = "Subir";
  fileInputChat.value = '';
};

async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  formData.append("folder", CLOUDINARY_FOLDER);

  const res = await fetch(url, {
    method: "POST",
    body: formData
  });

  if(!res.ok){
    throw new Error("Error al subir archivo");
  }
  return await res.json(); // 🔹 aquí viene el secure_url
}

btnLeave.onclick = () => {
  currentChatId = null;
  messagesWrap.innerHTML = '<p class="muted">Selecciona un chat</p>';

  // 🔹 Si es celular → volver a mostrar la lista
  if (window.innerWidth <= 860) {
    document.querySelector(".sidebar-card").style.display = "flex";
    document.querySelector(".chat-panel").classList.remove("active");
  }
};


btnIndex.onclick = ()=>{ window.location.href="index.html"; };
btnLogout.onclick = ()=> signOut(auth).then(()=>window.location.href="login.html");

onAuthStateChanged(auth, async (user)=>{
  if (!user){ location.href="login.html"; return; }
  currentUser = user;
  await loadMyChats();
  await loadContactsByGrade();
});
</script>
</body>
</html>
