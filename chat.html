rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================
    // Usuarios
    // ========================
    match /usuarios/{userId} {
      // Solo el dueño puede leer/escribir su propio perfil
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ========================
    // Posts (solo docentes publican)
    // ========================
    match /posts/{postId} {
      // Cualquiera autenticado puede leer publicaciones
      allow read: if request.auth != null;

      // ✅ Solo docentes autorizados pueden publicar, editar y eliminar
      allow create, update, delete: if request.auth != null &&
        (request.auth.token.email == "hey.junda@gmail.com" ||
         request.auth.token.email == "yesenia.lisseth.flores@clases.edu.sv");

      // ------------------------
      // Comentarios dentro del post
      // ------------------------
      match /comments/{commentId} {
        // Todos los usuarios autenticados pueden leer comentarios
        allow read: if request.auth != null;

        // Todos los autenticados pueden escribir comentarios
        allow create: if request.auth != null;

        // Solo el autor o un docente puede borrarlo
        allow delete: if request.auth != null &&
          (request.auth.uid == resource.data.authorUid ||
           request.auth.token.email == "hey.junda@gmail.com" ||
           request.auth.token.email == "yesenia.lisseth.flores@clases.edu.sv");
      }
    }

    // ========================
    // Chats Privados / Grupales
    // ========================
    match /privateChats/{chatId} {
      // Solo los participantes pueden leer o escribir el chat
      allow read, update, delete: if request.auth != null && request.auth.token.email in resource.data.participants;
      allow create: if request.auth != null && request.auth.token.email in request.resource.data.participants;

      // Subcolección de mensajes
      match /messages/{messageId} {
        // Solo los participantes pueden leer o crear mensajes
        allow read, create: if request.auth != null &&
          request.auth.token.email in get(/databases/$(database)/documents/privateChats/$(chatId)).data.participants;

        // Solo el autor del mensaje puede borrarlo/editarlo
        allow update, delete: if request.auth != null &&
          request.auth.token.email == resource.data.authorEmail;
      }
    }

    // ========================
    // Calls - señalización WebRTC
    // ========================
    match /calls/{callId} {
      allow read, write: if request.auth != null 
                         && exists(/databases/$(database)/documents/privateChats/$(callId))
                         && request.auth.token.email in get(/databases/$(database)/documents/privateChats/$(callId)).data.participants;
    }
  }
}
